{% macro filter_checkbox(field, value, checked, count, hidden) %}
    {% set name = 'f[' ~ field.name ~ '][v][]' %}
    <div class="option{% if hidden %} d-none{% endif %}{% if checked %} filter-marked{% endif %}" title="{{ value }}">
        <input type="checkbox" id="{{ name }}" name="{{ name }}" value="{{ value }}"
               {% if checked %}checked{% endif %}
        />
        <span>{{ value }}</span>
        <div class="count"><span>{{ count }}</span></div>
    </div>
{% endmacro %}

{#
  Renders a filter block, note that filters which are not visible can still be shown via
  the ellipsis button at the bottom of the filter panel. Hidden filters are rendered as
  hidden elements to support secondary searches (the filter panel being the primary search)
#}
{% macro filter_field(field, stats, searchFilter, visible, hidden) %}
    {% import _self as macros %}
    {% set filter = searchFilter[field.name]|default([]) %}
    {% set classes = [] %}
    {% set classes = classes|merge(not visible ? ['d-none'] : []) %}
    {% set classes = classes|merge(field.type in ['boolean', 'integer'] ? ['always-open'] : []) %}
    {% set classes = classes|merge(field.type == 'string' and filter['v'] is defined ? ['filter-marked'] : []) %}

    {% if hidden %}
        {% set value = filter['v']|default('') %}
        {% if value %}
        <input type="hidden" name="f[{{ field.name }}][v]" value="{{ value }}" >
        {% endif %}
    {% else %}
    <div class="filter {{ classes|join(' ') }}" id="filter-{{ field.name }}" title="{{ field.description }}">
        <div class="title"><span>{{ field.title }}</span></div>
        <div class="options-list">
            <div class="option-list-inner">
                {% if field.type == 'string' %}
                    {% set buckets = stats['vals_' ~ field.name]['buckets'] %}
                    {% set showMoreAfter = 5 %}
                    {% set showAutocomplete = 20 %}
                    {% set valuesUsed = [] %}
                    {% if buckets|length > showAutocomplete %}
                        {% set showMoreAfter = 4 %}
                        <div class="option search-complete">
                            <input type="search" name="f[{{ field.name }}][v][search]" id="filter-{{ field.name }}-search"
                                   placeholder="Filter for&hellip;" class="form-control adl-autocomplete"
                            />
                        </div>
                    {% endif %}
                    {% for bucket in buckets %}
                        {% set valuesUsed = valuesUsed|merge([bucket.key]) %}
                        {{ macros.filter_checkbox(field, bucket.key, bucket.key in filter['v']|default([]), bucket.doc_count, loop.index0 >= showMoreAfter) }}
                    {% endfor %}
                    {% for value in filter['v']|default([]) if value != '' and value not in valuesUsed %}
                        {{ macros.filter_checkbox(field, value, true, 0, false) }}
                    {% endfor %}
                    {% if buckets|length > showMoreAfter %}
                        <div class="option show-more"><span>&darr;</span></div>
                    {% endif %}
                {% elseif field.type == 'boolean' %}
                    <div class="option">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio"
                                   name="f[{{ field.name }}][v]" value=""
                                   {% if filter['v']|default('') == '' %}checked{% endif %}
                            /> All
                        </label>
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio"
                                   name="f[{{ field.name }}][v]" value="1"
                                   {% if filter['v']|default('') == '1' %}checked{% endif %}
                            /> Yes
                        </label>
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio"
                                   name="f[{{ field.name }}][v]" value="0"
                                   {% if filter['v']|default('') == '0' %}checked{% endif %}
                            /> No
                        </label>
                    </div>
                {% elseif field.type == 'integer' %}
                    <div class="option integer-option">
                        <input type="number" name="f[{{ field.name }}][v][min]" id="filter-{{ field.name }}-min"
                               placeholder="min (inc.)" class="form-control form-control-sm adl-integer-left"
                               value="{{ filter['v']|default({min: ''})['min'] }}"
                               title="min (inc.)"
                        />
                        <input type="number" name="f[{{ field.name }}][v][max]" id="filter-{{ field.name }}-max"
                               placeholder="max (inc.)" class="form-control form-control-sm adl-integer-right"
                               value="{{ filter['v']|default({max: ''})['max'] }}"
                               title="max (inc.)"
                        />
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% import _self as macros %}
{% set showMoreAfter = 11 %}
{% set visible_fields = [
  'publisher',
  'setting',
  'edition',
  'environments',
  'items',
  'bossMonsters',
  'commonMonsters',
  'numPages',
  'minStartingLevel',
  'maxStartingLevel',
  'startingLevelRange',
  'soloable',
  'pregeneratedCharacters',
  'handouts',
  'tacticalMaps',
  'partOf',
  'foundIn'
 ]
%}
{% for field in fields %}
    {% set showMoreAfter = showMoreAfter - (field.name in visible_fields) %}
    {{ macros.filter_field(field, stats, searchFilter, showMoreAfter > 0, field.name not in visible_fields) }}
{% endfor %}
